Qualtrics.SurveyEngine.addOnload(function()
{
  const s = document.createElement("script");
  s.src = "https://rafaelgottardo.github.io/occupations-qualtrics/occupations.js";
  document.head.appendChild(s);

});

Qualtrics.SurveyEngine.addOnReady(function() {
    jQuery(function() {

        // Decode Unicode characters
        function decodeUnicode(str) {
            return str.replace(/\\u[\dA-F]{4}/gi, function(match) {
                return String.fromCharCode(parseInt(match.replace(/\\u/g, ''), 16));
            });
        }

        // Normalize Unicode to remove accents and convert to lower case
        function normalizeString(str) {
            return decodeUnicode(str).normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase(); 
        }

        // Prepare data for Select2
        var select2Data = occupation_names.map(function(name, index) {
            var decodedName = decodeUnicode(name);
            var decodedCategory = decodeUnicode(occupation_category[index]); 
            return {
                id: occupation_codes[index], // Use code as the id
                text: decodedName, // Display name with decoded Unicode
                category: decodedCategory // Display decoded category
            };
        });


        // Ensure Select2 library is included before initialization
        if (typeof jQuery.fn.select2 === 'function') {
            jQuery(".QR-QID1").each(function() {
                // Ensure the element exists before initializing Select2
                if (jQuery(this).length) {
                    jQuery(this).select2({
                        data: select2Data,
                        minimumInputLength: 3,
                        matcher: function(params, data) {
                            // If there are no search terms, return all data
                            if ($.trim(params.term) === '') {
                                return data;
                            }

                            // Normalize and case-insensitive comparison
                            var normalizedParams = normalizeString(params.term);
                            var normalizedDataText = normalizeString(data.text);

                            // Check if the search term matches the text
                            if (normalizedDataText.indexOf(normalizedParams) > -1) {
                                return data;
                            }

                            // Return null if no match
                            return null;
                        },
                        templateResult: function(item) {
                            return item.text;
                        },
                        templateSelection: function(item) {
                            return item.text;
                        }
                    });
                }
            });

            // Handle selection change
            jQuery(".QR-QID1").on('select2:select', function(e) {
                var data = e.params.data;
                // Set embedded data for occupation code, name, and category
                Qualtrics.SurveyEngine.setEmbeddedData('occupation-name', data.text);
                Qualtrics.SurveyEngine.setEmbeddedData('occupation-code', data.id);
                Qualtrics.SurveyEngine.setEmbeddedData('occupation-category', data.category);
            });
        } else {
            console.error("Select2 library is not loaded.");
        }
    });
});




    Qualtrics.SurveyEngine.addOnPageSubmit(function() {
        var selectedData = jQuery(".QR-QID1").select2('data')[0]; 
        if (selectedData) {
            // Set embedded data
            Qualtrics.SurveyEngine.setEmbeddedData('occupation-name', selectedData.text);
            Qualtrics.SurveyEngine.setEmbeddedData('occupation-code', selectedData.id);
            Qualtrics.SurveyEngine.setEmbeddedData('occupation-category', selectedData.category);

        }
    });
